<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Crossplane is a framework for building cloud native control planes without needing to write code. It has a highly extensible backend that enables you to build a control plane that can orchestrate applications and infrastructure no matter where they run, and a highly configurable frontend that puts you in control of the schema of the declarative API it offers."><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=robots content="noindex"><title>Adding Secret Store Support| Crossplane Documentation</title><meta name=twitter:card content="summary"><meta name=twitter:site content="https://crossplane.io"><meta name=twitter:title content="Crossplane"><meta name=twitter:description content="The cloud-native control plane framework"><meta name=twitter:image:src content="https://crossplane.io/images/twitter-card_400x400.jpg"><link rel=apple-touch-icon sizes=180x180 href="/favicons/apple-touch-icon.png?v=1.0"><link rel=icon type=image/png sizes=32x32 href="/favicons/favicon-32x32.png?v=1.0"><link rel=icon type=image/png sizes=16x16 href="/favicons/favicon-16x16.png?v=1.0"><link rel=manifest href="/favicons/site.webmanifest?v=1.0"><link rel=mask-icon href="/favicons/safari-pinned-tab.svg?v=1.0" color=#5bbad5><link rel="shortcut icon" href="/favicons/favicon.ico?v=1.0"><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=/css/main.css><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css><link rel=stylesheet href=/css/docs.css><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js></script>
<script src=https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js></script></head><body><div id=header><div><div class=logo><a href=/><img src=/images/logo.svg alt="Crossplane Logo"></a></div><div class=hamburger-controls onclick='return document.body.classList.contains("menu-open")?document.body.classList.remove("menu-open"):document.body.classList.add("menu-open"),!1'><span></span>
<span></span>
<span></span></div><ul class=links><li><a href=https://github.com/crossplane/crossplane><span class=md-hidden>Get Started on</span> GitHub</a></li><li><a href=/v1.9/>Documentation</a></li><li><a href=/community/>Community</a></li><li><a href=https://slack.crossplane.io/>Slack <span class=md-hidden>Channel</span></a></li><li><a href=https://blog.crossplane.io/>Blog</a></li><li><a href=https://twitter.com/crossplane_io>Twitter</a></li></ul></div></div><div id=docs-header><div><h1>Documentation</h1><div class=versions><div><div><select onchange="window.location.href=this.value"><option selected value=/master/contributing/adding_external_secret_store_support/>Crossplane master</option><option value=/v1.9/contributing/adding_external_secret_store_support/>Crossplane v1.9</option><option value=/v1.8/contributing/adding_external_secret_store_support/>Crossplane v1.8</option><option selected value=/v1.7/contributing/adding_external_secret_store_support/>Crossplane v1.7</option></select></div></div></div></div></div><div class=page><div class=docs-menu><ul id=docs-ul></ul></div><div class=docs-content><div class=docs-actions><a id=edit href=https://github.com/crossplane/crossplane/tree/release-1.7/docs/adding_external_secret_store_support.md><img src=/images/github-teal.svg>Edit on GitHub</a></div><div class="alert old"><p><b>PLEASE NOTE</b>: This document applies to version 1.7 and not to the latest release 1.9</p><strong>Documentation for other releases can be found by using the version selector in the top right of any doc page.</strong></div><h1>Adding Secret Store Support</h1><p>To add support for <a href=https://github.com/crossplane/crossplane/blob/master/design/design-doc-external-secret-stores.md>External Secret Stores</a> in a provider, we need the following
changes at a high level:</p><ol><li>Bump Crossplane Runtime and Crossplane Tools to latest and generate existing
resources to include <code>PublishConnectionDetails</code> API.</li><li>Add a new Type and CRD for Secret StoreConfig.</li><li>Add feature flag for enabling External Secret Store support.</li><li>Add Secret Store Connection Details Manager as a <code>ConnectionPublisher</code> if
feature enabled.</li></ol><p>In this document, we will go through each step in details. You can check
<a href=https://github.com/crossplane/provider-gcp/pull/421>this PR as a complete example</a>.</p><blockquote><p>If your provider is a Terrajet based provider, then please check
<a href=https://github.com/crossplane-contrib/provider-jet-template/pull/23/commits>this PR instead</a>.</p></blockquote><h2 id=steps>Steps</h2><p><strong>1. Bump Crossplane Runtime and Crossplane Tools to latest and generate
existing resources to include <code>PublishConnectionDetails</code> API.</strong></p><p>We need a workaround for code generation since latest runtime both adds new API
but also adds a new interface to managed.resourceSpec. Without this workaround,
expect errors similar to below:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>16:40:56 <span style=color:#f92672>[</span> .. <span style=color:#f92672>]</span> go generate darwin_amd64
</span></span><span style=display:flex><span>angryjet: error: error loading packages using pattern ./...: /Users/hasanturken/  Workspace/crossplane/provider-gcp/apis/cache/v1beta1/zz_  generated.managedlist.go:27:14: cannot use &amp;l.Items<span style=color:#f92672>[</span>i<span style=color:#f92672>]</span> <span style=color:#f92672>(</span>value of type *  CloudMemorystoreInstance<span style=color:#f92672>)</span> as <span style=color:#e6db74>&#34;github.com/crossplane/crossplane-runtime/pkg/  resource&#34;</span>.Managed value in assignment: missing method GetPublishConnectionDetailsTo
</span></span><span style=display:flex><span>exit status <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>apis/generate.go:30: running <span style=color:#e6db74>&#34;go&#34;</span>: exit status <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>16:41:04 <span style=color:#f92672>[</span>FAIL<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>make<span style=color:#f92672>[</span>1<span style=color:#f92672>]</span>: *** <span style=color:#f92672>[</span>go.generate<span style=color:#f92672>]</span> Error <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>make: *** <span style=color:#f92672>[</span>generate<span style=color:#f92672>]</span> Error <span style=color:#ae81ff>2</span>
</span></span></code></pre></div><p>First, we need to consume a temporary runtime version together with the latest
Crossplane Tools:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>go mod edit -replace<span style=color:#f92672>=</span>github.com/crossplane/crossplane-runtime<span style=color:#f92672>=</span>github.com/turkenh/crossplane-runtime@v0.0.0-20220314141040-6f74175d3c1f
</span></span><span style=display:flex><span>go get github.com/crossplane/crossplane-tools@master
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>go mod tidy
</span></span></code></pre></div><p>Then, remove <code>trivialVersions=true</code> in the file <code>api/generate.go</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span><span style=color:#f92672>-//go:generate go run -tags generate sigs.k8s.io/controller-tools/cmd/controller-gen object:headerFile=../hack/boilerplate.go.txt paths=./... crd:trivialVersions=true,crdVersions=v1 output:artifacts:config=../package/crds
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+//go:generate go run -tags generate sigs.k8s.io/controller-tools/cmd/controller-gen object:headerFile=../hack/boilerplate.go.txt paths=./... crd:crdVersions=v1 output:artifacts:config=../package/crds
</span></span></span></code></pre></div><p>Now, we can generate CRDs with <code>PublishConnectionDetailsTo</code> API:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>make generate
</span></span></code></pre></div><p>Finally, we can revert our workaround by consuming the latest Crossplane
Runtime:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>go mod edit -dropreplace<span style=color:#f92672>=</span>github.com/crossplane/crossplane-runtime
</span></span><span style=display:flex><span>go get github.com/crossplane/crossplane-runtime@master
</span></span><span style=display:flex><span>go mod tidy
</span></span><span style=display:flex><span>make generate
</span></span></code></pre></div><p><strong>2. Add a new Type and CRD for Secret StoreConfig.</strong></p><p>See <a href=https://github.com/crossplane-contrib/provider-aws/pull/1242/commits/d8a2df323fa2489d82bf1843d2fe338de033c61d>this commit as an example on how to add the type</a>. It is expected to be
almost same for all providers except groupName which includes the name short
name of the provider (e.g. <code>gcp.crossplane.io</code>)</p><p>Generate the CRD with:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>make generate
</span></span></code></pre></div><p><strong>3. Add feature flag for enabling External Secret Store support.</strong></p><p>We will add a feature flag to enable the feature which would be off by default.
As part of this step, we will also create a <code>default</code> <code>StoreConfig</code> during
provider start up, which stores connection secrets into the same Kubernetes
cluster.</p><p>To be consistent across all providers, please define
<code>--enable-external-secret-stores</code> as a boolean which is false by default.</p><p>See <a href=https://github.com/crossplane/provider-gcp/pull/421/commits/b5898c62dc6668d9918496de8aa9bc365c371f82>this commit as an example for adding the feature flag</a>.</p><p><strong>4. Add Secret Store Connection Details Manager as a <code>ConnectionPublisher</code> if
feature enabled.</strong></p><p>Add the following to the Setup function controller. Unfortunately this step
requires some dirty work as we need to this for all types:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span> func SetupServiceAccountKey(mgr ctrl.Manager, o controller.Options) error {
</span></span><span style=display:flex><span>      name := managed.ControllerName(v1alpha1.ServiceAccountKeyGroupKind)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>+       cps := []managed.ConnectionPublisher{managed.NewAPISecretPublisher(mgr.GetClient(), mgr.GetScheme())}
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+       if o.Features.Enabled(features.EnableAlphaExternalSecretStores) {
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+               cps = append(cps, connection.NewDetailsManager(mgr.GetClient(), scv1alpha1.StoreConfigGroupVersionKind))
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+       }
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>      r := managed.NewReconciler(mgr,
</span></span><span style=display:flex><span>              resource.ManagedKind(v1alpha1.ServiceAccountKeyGroupVersionKind),
</span></span><span style=display:flex><span>              managed.WithInitializers(),
</span></span><span style=display:flex><span>              managed.WithExternalConnecter(&amp;serviceAccountKeyServiceConnector{client: mgr.GetClient()}),
</span></span><span style=display:flex><span>              managed.WithPollInterval(o.PollInterval),
</span></span><span style=display:flex><span>              managed.WithLogger(o.Logger.WithValues(&#34;controller&#34;, name)),
</span></span><span style=display:flex><span><span style=color:#f92672>-               managed.WithRecorder(event.NewAPIRecorder(mgr.GetEventRecorderFor(name))))
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+               managed.WithRecorder(event.NewAPIRecorder(mgr.GetEventRecorderFor(name))),
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+               managed.WithConnectionPublishers(cps...))
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>
</span></span><span style=display:flex><span>      return ctrl.NewControllerManagedBy(mgr).
</span></span><span style=display:flex><span>              Named(name).
</span></span></code></pre></div><p>You can check <a href=https://github.com/crossplane/provider-gcp/pull/421/commits/9700d0c4fdb7e1fba8805afa309c1b1c7aa167a6>this commit as an example for changes in Setup functions</a> as an
example.</p></div></div><script>var i,j,menu=[],menuDom,item,itemDom,children;menu.push({childCurrent:!1,children:[{current:!1,name:"Install \u0026 Configure",url:"/v1.7/getting-started/install-configure/"},{current:!1,name:"Provision Infrastructure",url:"/v1.7/getting-started/provision-infrastructure/"},{current:!1,name:"Create a Configuration",url:"/v1.7/getting-started/create-configuration/"}],current:!1,name:"Getting Started",url:"/v1.7/getting-started/"}),menu.push({childCurrent:!1,children:[{current:!1,name:"Providers",url:"/v1.7/concepts/providers/"},{current:!1,name:"Managed Resources",url:"/v1.7/concepts/managed-resources/"},{current:!1,name:"Composite Resources",url:"/v1.7/concepts/composition/"},{current:!1,name:"Packages",url:"/v1.7/concepts/packages/"},{current:!1,name:"Terminology",url:"/v1.7/concepts/terminology/"}],current:!1,name:"Concepts",url:"/v1.7/concepts/"}),menu.push({childCurrent:!1,children:[{current:!1,name:"Upgrading to v0.14",url:"/v1.7/guides/upgrading-to-v0.14/"},{current:!1,name:"Upgrading to v1.x",url:"/v1.7/guides/upgrading-to-v1.x/"},{current:!1,name:"Vault as an External Secret Store",url:"/v1.7/guides/vault-as-secret-store/"},{current:!1,name:"Vault Credential Injection",url:"/v1.7/guides/vault-injection/"},{current:!1,name:"Multi-Tenant Crossplane",url:"/v1.7/guides/multi-tenant/"},{current:!1,name:"Composition Revisions",url:"/v1.7/guides/composition-revisions/"},{current:!1,name:"Self-Signed CA Certs",url:"/v1.7/guides/self-signed-ca-certs/"}],current:!1,name:"Guides",url:"/v1.7/guides/"}),menu.push({childCurrent:!1,children:[{current:!1,name:"Install Crossplane",url:"/v1.7/reference/install/"},{current:!1,name:"Configure Your Cloud Provider Account",url:"/v1.7/reference/configure/"},{current:!1,name:"Uninstall",url:"/v1.7/reference/uninstall/"},{current:!1,name:"Composition",url:"/v1.7/reference/composition/"},{current:!1,name:"xpkg Specification",url:"/v1.7/reference/xpkg/"},{current:!1,name:"Troubleshoot",url:"/v1.7/reference/troubleshoot/"},{current:!1,name:"Learn More",url:"/v1.7/reference/learn_more/"},{current:!1,name:"Release Cycle",url:"/v1.7/reference/release-cycle/"}],current:!1,name:"Reference",url:"/v1.7/reference/"}),menu.push({childCurrent:!1,children:[{current:!1,name:"crossplane",url:"/v1.7/api-docs/crossplane/"},{current:!1,name:"provider-alibaba",url:"/v1.7/api-docs/provider-alibaba/"},{current:!1,name:"provider-aws",url:"/v1.7/api-docs/provider-aws/"},{current:!1,name:"provider-azure",url:"/v1.7/api-docs/provider-azure/"},{current:!1,name:"provider-gcp",url:"/v1.7/api-docs/provider-gcp/"},{current:!1,name:"provider-rook",url:"/v1.7/api-docs/provider-rook/"},{current:!1,name:"provider-helm",url:"/v1.7/api-docs/provider-helm/"}],current:!1,name:"API Documentation",url:"/v1.7/api-docs/"}),menu.push({childCurrent:!0,children:[{current:!1,name:"Provider Development Guide",url:"/v1.7/contributing/provider_development_guide/"},{current:!1,name:"Observability Developer Guide",url:"/v1.7/contributing/observability_developer_guide/"},{current:!1,name:"Release Process",url:"/v1.7/contributing/release-process/"},{current:!0,name:"Adding Secret Store Support",url:"/v1.7/contributing/adding_external_secret_store_support/"}],current:!1,name:"Contributing",url:"/v1.7/contributing/"}),menu.push({childCurrent:!1,children:[{current:!1,name:"Related Projects",url:"/v1.7/faqs/related_projects/"}],current:!1,name:"FAQ",url:"/v1.7/faqs/"});function getEntry(e){var t=document.createElement("li");return e.current?(t.innerHTML=e.name,t.classList.add("current")):t.innerHTML='<a href="'+e.url+'">'+e.name+"</a>",t}function flushCss(e){e.offsetHeight}function addArrow(e){var t=document.createElement("a");t.classList.add("arrow"),t.innerHTML="<div />",t.onclick=function(e){return function(){var n=59,s=16,t=n+s+e.lastChild.clientHeight+"px";return e.classList.toggle("open"),e.classList.contains("open")?e.style.height=t:(e.style.height==="auto"&&(e.style.transition="none",e.style.height=t,flushCss(e),e.style.transition=""),e.style.height="59px"),!1}}(e),e.appendChild(t),item.current&&item.children||item.childCurrent?(e.classList.add("open"),e.style.height="auto"):e.style.height="59px"}menuDom=document.getElementById("docs-ul");for(i=0;i<menu.length;i++){if(item=menu[i],itemDom=getEntry(item),item.childCurrent&&itemDom.classList.add("childCurrent"),item.children){addArrow(itemDom),itemDom.classList.add("children"),children=document.createElement("ul");for(j=0;j<item.children.length;j++)children.appendChild(getEntry(item.children[j]));itemDom.appendChild(children)}menuDom.appendChild(itemDom)}</script><script src=/js/anchor.js></script>
<script>anchors.options={placement:"right",icon:"#"},document.addEventListener("DOMContentLoaded",function(){anchors.add(".docs-content h1, .docs-content h2, .docs-content h3, .docs-content h4, .docs-content h5, .docs-content h6")})</script><div id=footer><div class=footer-main><div class=main><div class=logo><img src=/images/logo.svg alt="Crossplane Logo"></div></div><div class="links sm-hidden"><a href=https://twitter.com/crossplane_io>Twitter</a>
<a href=/v1.9/>Documentation</a>
<a href=https://github.com/crossplane/crossplane>GitHub</a>
<a href=https://slack.crossplane.io/>Slack Channel</a>
<a href=https://www.youtube.com/channel/UC19FgzMBMqBro361HbE46Fw>YouTube</a>
<a href=https://groups.google.com/forum/#!forum/crossplane-dev>Forum</a></div></div><div class=lf-copyright><p>&#169; Crossplane Authors 2022. Documentation distributed under
<a href=https://creativecommons.org/licenses/by/4.0/>CC-BY-4.0</a>.</p><p>&#169; 2022 The Linux Foundation. All rights reserved. The Linux Foundation has
registered trademarks and uses trademarks. For a list of trademarks of The Linux Foundation, please see our
<a href=https://www.linuxfoundation.org/trademark-usage/>Trademark Usage</a> page.</p></div><script src=/js/slack-popup.js></script></div><script>(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)})(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-110275540-2","auto"),ga("send","pageview")</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-SFCPQYSLHY"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-SFCPQYSLHY")</script><script type=text/javascript id=hs-script-loader async defer src=https://js.hs-scripts.com/5557732.js></script></body></html>