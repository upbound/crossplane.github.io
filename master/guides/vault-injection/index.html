<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Crossplane is a framework for building cloud native control planes without needing to write code. It has a highly extensible backend that enables you to build a control plane that can orchestrate applications and infrastructure no matter where they run, and a highly configurable frontend that puts you in control of the schema of the declarative API it offers."><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=robots content="noindex"><title>Vault Credential Injection| Crossplane Documentation</title><meta name=twitter:card content="summary"><meta name=twitter:site content="https://crossplane.io"><meta name=twitter:title content="Crossplane"><meta name=twitter:description content="The cloud-native control plane framework"><meta name=twitter:image:src content="https://crossplane.io/images/twitter-card_400x400.jpg"><link rel=apple-touch-icon sizes=180x180 href="/favicons/apple-touch-icon.png?v=1.0"><link rel=icon type=image/png sizes=32x32 href="/favicons/favicon-32x32.png?v=1.0"><link rel=icon type=image/png sizes=16x16 href="/favicons/favicon-16x16.png?v=1.0"><link rel=manifest href="/favicons/site.webmanifest?v=1.0"><link rel=mask-icon href="/favicons/safari-pinned-tab.svg?v=1.0" color=#5bbad5><link rel="shortcut icon" href="/favicons/favicon.ico?v=1.0"><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><link rel=stylesheet href=/css/main.css><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css><link rel=stylesheet href=/css/docs.css><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js></script>
<script src=https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js></script></head><body><div id=header><div><div class=logo><a href=/><img src=/images/logo.svg alt="Crossplane Logo"></a></div><div class=hamburger-controls onclick='return document.body.classList.contains("menu-open")?document.body.classList.remove("menu-open"):document.body.classList.add("menu-open"),!1'><span></span>
<span></span>
<span></span></div><ul class=links><li><a href=https://github.com/crossplane/crossplane><span class=md-hidden>Get Started on</span> GitHub</a></li><li><a href=/v1.9/>Documentation</a></li><li><a href=/community/>Community</a></li><li><a href=https://slack.crossplane.io/>Slack <span class=md-hidden>Channel</span></a></li><li><a href=https://blog.crossplane.io/>Blog</a></li><li><a href=https://twitter.com/crossplane_io>Twitter</a></li></ul></div></div><div id=docs-header><div><h1>Documentation</h1><div class=versions><div><div><select onchange="window.location.href=this.value"><option selected value=/master/guides/vault-injection/>Crossplane master</option><option value=/v1.9/guides/vault-injection/>Crossplane v1.9</option><option value=/v1.8/guides/vault-injection/>Crossplane v1.8</option><option value=/v1.7/guides/vault-injection/>Crossplane v1.7</option></select></div></div></div></div></div><div class=page><div class=docs-menu><ul id=docs-ul></ul></div><div class=docs-content><div class=docs-actions><a id=edit href=https://github.com/crossplane/crossplane/tree/master/docs/vault-injection.md><img src=/images/github-teal.svg>Edit on GitHub</a></div><div class="alert master"><p><b>PLEASE NOTE</b>: This document applies to an <b>unreleased</b> version of Crossplane. It is strongly recommended that you only use official releases of Crossplane, as unreleased versions are subject to changes and incompatibilities that will not be supported in the official releases.</p><p>If you are using an official release version of Crossplane, you should refer to the documentation for your specific version.</p><strong>Documentation for other releases can be found by using the version selector in the top right of any doc page.</strong></div><h1>Vault Credential Injection</h1><blockquote><p>This guide is adapted from the <a href=https://learn.hashicorp.com/tutorials/vault/kubernetes-minikube>Vault on Minikube</a> and <a href=https://learn.hashicorp.com/tutorials/vault/kubernetes-sidecar>Vault Kubernetes
Sidecar</a> guides.</p></blockquote><p>Most Crossplane providers support supplying credentials from at least the
following sources:</p><ul><li>Kubernetes Secret</li><li>Environment Variable</li><li>Filesystem</li></ul><p>A provider may optionally support additional credentials sources, but the common
sources cover a wide variety of use cases. One specific use case that is popular
among organizations that use <a href=https://www.vaultproject.io/>Vault</a> for secrets management is using a sidecar
to inject credentials into the filesystem. This guide will demonstrate how to
use the <a href=https://learn.hashicorp.com/tutorials/vault/kubernetes-sidecar>Vault Kubernetes Sidecar</a> to provide credentials for <a href=https://github.com/crossplane-contrib/provider-gcp>provider-gcp</a>
and <a href=https://github.com/crossplane-contrib/provider-aws>provider-aws</a>.</p><blockquote><p>Note: in this guide we will copy GCP credentials and AWS access keys
into Vault&rsquo;s KV secrets engine. This is a simple generic approach to
managing secrets with Vault, but is not as robust as using Vault&rsquo;s
dedicated cloud provider secrets engines for <a href=https://www.vaultproject.io/docs/secrets/aws>AWS</a>, <a href=https://www.vaultproject.io/docs/secrets/azure>Azure</a>, and <a href=https://www.vaultproject.io/docs/secrets/gcp>GCP</a>.</p></blockquote><h2 id=setup>Setup</h2><blockquote><p>Note: this guide walks through setting up Vault running in the same cluster as
Crossplane. You may also choose to use an existing Vault instance that runs
outside the cluster but has Kubernetes authentication enabled.</p></blockquote><p>Before getting started, you must ensure that you have installed Crossplane and
Vault and that they are running in your cluster.</p><ol><li>Install Crossplane</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>kubectl create namespace crossplane-system
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>helm repo add crossplane-stable https://charts.crossplane.io/stable
</span></span><span style=display:flex><span>helm repo update
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>helm install crossplane --namespace crossplane-system crossplane-stable/crossplane
</span></span></code></pre></div><ol start=2><li>Install Vault Helm Chart</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>helm repo add hashicorp https://helm.releases.hashicorp.com
</span></span><span style=display:flex><span>helm install vault hashicorp/vault
</span></span></code></pre></div><ol start=3><li>Unseal Vault Instance</li></ol><p>In order for Vault to access encrypted data from physical storage, it must be
<a href=https://www.vaultproject.io/docs/concepts/seal>unsealed</a>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>kubectl exec vault-0 -- vault operator init -key-shares=1 -key-threshold=1 -format=json &gt; cluster-keys.json
</span></span><span style=display:flex><span>VAULT_UNSEAL_KEY=$(cat cluster-keys.json | jq -r &#34;.unseal_keys_b64[]&#34;)
</span></span><span style=display:flex><span>kubectl exec vault-0 -- vault operator unseal $VAULT_UNSEAL_KEY
</span></span></code></pre></div><ol start=4><li>Enable Kubernetes Authentication Method</li></ol><p>In order for Vault to be able to authenticate requests based on Kubernetes
service accounts, the <a href=https://www.vaultproject.io/docs/auth/kubernetes>Kubernetes authentication backend</a> must be enabled. This
requires logging in to Vault and configuring it with a service account token,
API server address, and certificate. Because we are running Vault in Kubernetes,
these values are already available via the container filesystem and environment
variables.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>cat cluster-keys.json | jq -r &#34;.root_token&#34; # get root token
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>kubectl exec -it vault-0 -- /bin/sh
</span></span><span style=display:flex><span>vault login # use root token from above
</span></span><span style=display:flex><span>vault auth enable kubernetes
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>vault write auth/kubernetes/config \
</span></span><span style=display:flex><span>        token_reviewer_jwt=&#34;$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)&#34; \
</span></span><span style=display:flex><span>        kubernetes_host=&#34;https://$KUBERNETES_PORT_443_TCP_ADDR:443&#34; \
</span></span><span style=display:flex><span>        kubernetes_ca_cert=@/var/run/secrets/kubernetes.io/serviceaccount/ca.crt
</span></span></code></pre></div><ol start=5><li>Exit Vault Container</li></ol><p>The next steps will be executed in your local environment.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>exit
</span></span></code></pre></div><ul class="nav nav-tabs"><li class=active><a href=#aws-tab-1 data-toggle=tab>AWS</a></li><li><a href=#gcp-tab-1 data-toggle=tab>GCP</a></li></ul><br><div class=tab-content><div class="tab-pane fade" id=gcp-tab-1 markdown=1><h2 id=create-gcp-service-account>Create GCP Service Account</h2><p>In order to provision infrastructure on GCP, you will need to create a service
account with appropriate permissions. In this guide we will only provision a
CloudSQL instance, so the service account will be bound to the <code>cloudsql.admin</code>
role. The following steps will setup a GCP service account, give it the
necessary permissions for Crossplane to be able to manage CloudSQL instances,
and emit the service account credentials in a JSON file.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span># replace this with your own gcp project id and the name of the service account
</span></span><span style=display:flex><span># that will be created.
</span></span><span style=display:flex><span>PROJECT_ID=my-project
</span></span><span style=display:flex><span>NEW_SA_NAME=test-service-account-name
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span># create service account
</span></span><span style=display:flex><span>SA=&#34;${NEW_SA_NAME}@${PROJECT_ID}.iam.gserviceaccount.com&#34;
</span></span><span style=display:flex><span>gcloud iam service-accounts create $NEW_SA_NAME --project $PROJECT_ID
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span># enable cloud API
</span></span><span style=display:flex><span>SERVICE=&#34;sqladmin.googleapis.com&#34;
</span></span><span style=display:flex><span>gcloud services enable $SERVICE --project $PROJECT_ID
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span># grant access to cloud API
</span></span><span style=display:flex><span>ROLE=&#34;roles/cloudsql.admin&#34;
</span></span><span style=display:flex><span>gcloud projects add-iam-policy-binding --role=&#34;$ROLE&#34; $PROJECT_ID --member &#34;serviceAccount:$SA&#34;
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span># create service account keyfile
</span></span><span style=display:flex><span>gcloud iam service-accounts keys create creds.json --project $PROJECT_ID --iam-account $SA
</span></span></code></pre></div><p>You should now have valid service account credentials in <code>creds.json</code>.</p><h2 id=store-credentials-in-vault>Store Credentials in Vault</h2><p>After setting up Vault, you will need to store your credentials in the <a href=https://www.vaultproject.io/docs/secrets/kv/kv-v2>kv
secrets engine</a>.</p><blockquote><p>Note: the steps below involve copying credentials into the container
filesystem before storing them in Vault. You may also choose to use Vault&rsquo;s
HTTP API or UI by port-forwarding the container to your local environment
(<code>kubectl port-forward vault-0 8200:8200</code>).</p></blockquote><ol><li>Copy Credentials File into Vault Container</li></ol><p>Copy your credentials into the container filesystem so that your can store them
in Vault.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>kubectl cp creds.json vault-0:/tmp/creds.json
</span></span></code></pre></div><ol start=2><li>Enable KV Secrets Engine</li></ol><p>Secrets engines must be enabled before they can be used. Enable the <code>kv-v2</code>
secrets engine at the <code>secret</code> path.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>kubectl exec -it vault-0 -- /bin/sh
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>vault secrets enable -path=secret kv-v2
</span></span></code></pre></div><ol start=3><li>Store GCP Credentials in KV Engine</li></ol><p>The path of your GCP credentials is how the secret will be referenced when
injecting it into the <code>provider-gcp</code> controller <code>Pod</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>vault kv put secret/provider-creds/gcp-default @tmp/creds.json
</span></span></code></pre></div><ol start=4><li>Clean Up Credentials File</li></ol><p>You no longer need our GCP credentials file in the container filesystem, so go
ahead and clean it up.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>rm tmp/creds.json
</span></span></code></pre></div></div><div class="tab-pane fade in active" id=aws-tab-1 markdown=1><h2 id=create-aws-iam-user>Create AWS IAM User</h2><p>In order to provision infrastructure on AWS, you will need to use an existing or create a new IAM
user with appropriate permissions. The following steps will create an AWS IAM user and give it the necessary
permissions.</p><blockquote><p>Note: if you have an existing IAM user with appropriate permissions, you can skip this step but you will
still need to provide the values for the <code>ACCESS_KEY_ID</code> and <code>AWS_SECRET_ACCESS_KEY</code> environment variables.</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span># create a new IAM user
</span></span><span style=display:flex><span>IAM_USER=test-user
</span></span><span style=display:flex><span>aws iam create-user --user-name $IAM_USER
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span># grant the IAM user the necessary permissions
</span></span><span style=display:flex><span>aws iam attach-user-policy --user-name $IAM_USER --policy-arn arn:aws:iam::aws:policy/AmazonS3FullAccess
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span># create a new IAM access key <span style=color:#66d9ef>for</span> the user
</span></span><span style=display:flex><span>aws iam create-access-key --user-name $IAM_USER &gt; creds.json
</span></span><span style=display:flex><span># assign the access key values to environment variables
</span></span><span style=display:flex><span>ACCESS_KEY_ID=$(jq -r .AccessKey.AccessKeyId creds.json)
</span></span><span style=display:flex><span>AWS_SECRET_ACCESS_KEY=$(jq -r .AccessKey.SecretAccessKey creds.json)
</span></span></code></pre></div><h2 id=store-credentials-in-vault-1>Store Credentials in Vault</h2><p>After setting up Vault, you will need to store your credentials in the <a href=https://www.vaultproject.io/docs/secrets/kv/kv-v2>kv
secrets engine</a>.</p><ol><li>Enable KV Secrets Engine</li></ol><p>Secrets engines must be enabled before they can be used. Enable the <code>kv-v2</code>
secrets engine at the <code>secret</code> path.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>kubectl exec -it vault-0 -- env \
</span></span><span style=display:flex><span>  ACCESS_KEY_ID=${ACCESS_KEY_ID} \
</span></span><span style=display:flex><span>  AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY} \
</span></span><span style=display:flex><span>  /bin/sh
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>vault secrets enable -path=secret kv-v2
</span></span></code></pre></div><ol start=2><li>Store AWS Credentials in KV Engine</li></ol><p>The path of your AWS credentials is how the secret will be referenced when
injecting it into the <code>provider-aws</code> controller <code>Pod</code>.</p><pre tabindex=0><code>vault kv put secret/provider-creds/aws-default access_key=&#34;$ACCESS_KEY_ID&#34; secret_key=&#34;$AWS_SECRET_ACCESS_KEY&#34;
</code></pre></div></div><h2 id=create-a-vault-policy-for-reading-provider-credentials>Create a Vault Policy for Reading Provider Credentials</h2><p>In order for our controllers to have the Vault sidecar inject the credentials
into their filesystem, you must associate the <code>Pod</code> with a <a href=https://www.vaultproject.io/docs/concepts/policies>policy</a>. This policy
will allow for reading and listing all secrets on the <code>provider-creds</code> path in
the <code>kv-v2</code> secrets engine.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>vault policy write provider-creds - &lt;&lt;EOF
</span></span><span style=display:flex><span>path &#34;secret/data/provider-creds/*&#34; {
</span></span><span style=display:flex><span>    capabilities = [&#34;read&#34;, &#34;list&#34;]
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>EOF
</span></span></code></pre></div><h2 id=create-a-role-for-crossplane-provider-pods>Create a Role for Crossplane Provider Pods</h2><ol><li>Create Role</li></ol><p>The last step is to create a role that is bound to the policy you created and
associate it with a group of Kubernetes service accounts. This role can be
assumed by any (<code>*</code>) service account in the <code>crossplane-system</code> namespace.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>vault write auth/kubernetes/role/crossplane-providers \
</span></span><span style=display:flex><span>        bound_service_account_names=&#34;*&#34; \
</span></span><span style=display:flex><span>        bound_service_account_namespaces=crossplane-system \
</span></span><span style=display:flex><span>        policies=provider-creds \
</span></span><span style=display:flex><span>        ttl=24h
</span></span></code></pre></div><ol start=2><li>Exit Vault Container</li></ol><p>The next steps will be executed in your local environment.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>exit
</span></span></code></pre></div><ul class="nav nav-tabs"><li class=active><a href=#aws-tab-2 data-toggle=tab>AWS</a></li><li><a href=#gcp-tab-2 data-toggle=tab>GCP</a></li></ul><br><div class=tab-content><div class="tab-pane fade" id=gcp-tab-2 markdown=1><h2 id=install-provider-gcp>Install provider-gcp</h2><p>You are now ready to install <code>provider-gcp</code>. Crossplane provides a
<code>ControllerConfig</code> type that allows you to customize the deployment of a
provider&rsquo;s controller <code>Pod</code>. A <code>ControllerConfig</code> can be created and referenced
by any number of <code>Provider</code> objects that wish to use its configuration. In the
example below, the <code>Pod</code> annotations indicate to the Vault mutating webhook that
we want for the secret stored at <code>secret/provider-creds/gcp-default</code> to be
injected into the container filesystem by assuming role <code>crossplane-providers</code>.
There is also so template formatting added to make sure the secret data is
presented in a form that <code>provider-gcp</code> is expecting.</p><p>{% raw %}</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>echo &#34;apiVersion: pkg.crossplane.io/v1alpha1
</span></span><span style=display:flex><span>kind: ControllerConfig
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: vault-config
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  metadata:
</span></span><span style=display:flex><span>    annotations:
</span></span><span style=display:flex><span>      vault.hashicorp.com/agent-inject: \&#34;true\&#34;
</span></span><span style=display:flex><span>      vault.hashicorp.com/role: &#34;crossplane-providers&#34;
</span></span><span style=display:flex><span>      vault.hashicorp.com/agent-inject-secret-creds.txt: &#34;secret/provider-creds/gcp-default&#34;
</span></span><span style=display:flex><span>      vault.hashicorp.com/agent-inject-template-creds.txt: |
</span></span><span style=display:flex><span>        {{- with secret \&#34;secret/provider-creds/gcp-default\&#34; -}}
</span></span><span style=display:flex><span>         {{ .Data.data | toJSON }}
</span></span><span style=display:flex><span>        {{- end -}}
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>apiVersion: pkg.crossplane.io/v1
</span></span><span style=display:flex><span>kind: Provider
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: provider-gcp
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  package: crossplane/provider-gcp:v0.16.0
</span></span><span style=display:flex><span>  controllerConfigRef:
</span></span><span style=display:flex><span>    name: vault-config&#34; | kubectl apply -f -
</span></span></code></pre></div><p>{% endraw %}</p><h2 id=configure-provider-gcp>Configure provider-gcp</h2><p>One <code>provider-gcp</code> is installed and running, you will want to create a
<code>ProviderConfig</code> that specifies the credentials in the filesystem that should be
used to provision managed resources that reference this <code>ProviderConfig</code>.
Because the name of this <code>ProviderConfig</code> is <code>default</code> it will be used by any
managed resources that do not explicitly reference a <code>ProviderConfig</code>.</p><blockquote><p>Note: make sure that the <code>PROJECT_ID</code> environment variable that was defined
earlier is still set correctly.</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>echo &#34;apiVersion: gcp.crossplane.io/v1beta1
</span></span><span style=display:flex><span>kind: ProviderConfig
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: default
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  projectID: ${PROJECT_ID}
</span></span><span style=display:flex><span>  credentials:
</span></span><span style=display:flex><span>    source: Filesystem
</span></span><span style=display:flex><span>    fs:
</span></span><span style=display:flex><span>      path: /vault/secrets/creds.txt&#34; | kubectl apply -f -
</span></span></code></pre></div><p>To verify that the GCP credentials are being injected into the container run the
following command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>PROVIDER_CONTROLLER_POD=$(kubectl -n crossplane-system get pod -l pkg.crossplane.io/provider=provider-gcp -o name --no-headers=true)
</span></span><span style=display:flex><span>kubectl -n crossplane-system exec -it $PROVIDER_CONTROLLER_POD -c provider-gcp -- cat /vault/secrets/creds.txt
</span></span></code></pre></div><h2 id=provision-infrastructure>Provision Infrastructure</h2><p>The final step is to actually provision a <code>CloudSQLInstance</code>. Creating the
object below will result in the creation of a Cloud SQL Postgres database on
GCP.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>echo &#34;apiVersion: database.gcp.crossplane.io/v1beta1
</span></span><span style=display:flex><span>kind: CloudSQLInstance
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: postgres-vault-demo
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  forProvider:
</span></span><span style=display:flex><span>    databaseVersion: POSTGRES_12
</span></span><span style=display:flex><span>    region: us-central1
</span></span><span style=display:flex><span>    settings:
</span></span><span style=display:flex><span>      tier: db-custom-1-3840
</span></span><span style=display:flex><span>      dataDiskType: PD_SSD
</span></span><span style=display:flex><span>      dataDiskSizeGb: 10
</span></span><span style=display:flex><span>  writeConnectionSecretToRef:
</span></span><span style=display:flex><span>    namespace: crossplane-system
</span></span><span style=display:flex><span>    name: cloudsqlpostgresql-conn&#34; | kubectl apply -f -
</span></span></code></pre></div><p>You can monitor the progress of the database provisioning with the following
command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>kubectl get cloudsqlinstance -w
</span></span></code></pre></div></div><div class="tab-pane fade in active" id=aws-tab-2 markdown=1><h2 id=install-provider-aws>Install provider-aws</h2><p>You are now ready to install <code>provider-aws</code>. Crossplane provides a
<code>ControllerConfig</code> type that allows you to customize the deployment of a
provider&rsquo;s controller <code>Pod</code>. A <code>ControllerConfig</code> can be created and referenced
by any number of <code>Provider</code> objects that wish to use its configuration. In the
example below, the <code>Pod</code> annotations indicate to the Vault mutating webhook that
we want for the secret stored at <code>secret/provider-creds/aws-default</code> to be
injected into the container filesystem by assuming role <code>crossplane-providers</code>.
There is also some template formatting added to make sure the secret data is
presented in a form that <code>provider-aws</code> is expecting.</p><p>{% raw %}</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>echo &#34;apiVersion: pkg.crossplane.io/v1alpha1
</span></span><span style=display:flex><span>kind: ControllerConfig
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: aws-vault-config
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  args:
</span></span><span style=display:flex><span>    - --debug
</span></span><span style=display:flex><span>  metadata:
</span></span><span style=display:flex><span>    annotations:
</span></span><span style=display:flex><span>      vault.hashicorp.com/agent-inject: \&#34;true\&#34;
</span></span><span style=display:flex><span>      vault.hashicorp.com/role: \&#34;crossplane-providers\&#34;
</span></span><span style=display:flex><span>      vault.hashicorp.com/agent-inject-secret-creds.txt: \&#34;secret/provider-creds/aws-default\&#34;
</span></span><span style=display:flex><span>      vault.hashicorp.com/agent-inject-template-creds.txt: |
</span></span><span style=display:flex><span>        {{- with secret \&#34;secret/provider-creds/aws-default\&#34; -}}
</span></span><span style=display:flex><span>          [default]
</span></span><span style=display:flex><span>          aws_access_key_id=&#34;{{ .Data.data.access_key }}&#34;
</span></span><span style=display:flex><span>          aws_secret_access_key=&#34;{{ .Data.data.secret_key }}&#34;
</span></span><span style=display:flex><span>        {{- end -}}
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>apiVersion: pkg.crossplane.io/v1
</span></span><span style=display:flex><span>kind: Provider
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: provider-aws
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  package: crossplane/provider-aws:v0.29.0
</span></span><span style=display:flex><span>  controllerConfigRef:
</span></span><span style=display:flex><span>    name: aws-vault-config&#34; | kubectl apply -f -
</span></span></code></pre></div><p>{% endraw %}</p><h2 id=configure-provider-aws>Configure provider-aws</h2><p>Once <code>provider-aws</code> is installed and running, you will want to create a
<code>ProviderConfig</code> that specifies the credentials in the filesystem that should be
used to provision managed resources that reference this <code>ProviderConfig</code>.
Because the name of this <code>ProviderConfig</code> is <code>default</code> it will be used by any
managed resources that do not explicitly reference a <code>ProviderConfig</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>echo &#34;apiVersion: aws.crossplane.io/v1beta1
</span></span><span style=display:flex><span>kind: ProviderConfig
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: default
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  credentials:
</span></span><span style=display:flex><span>    source: Filesystem
</span></span><span style=display:flex><span>    fs:
</span></span><span style=display:flex><span>      path: /vault/secrets/creds.txt&#34; | kubectl apply -f -
</span></span></code></pre></div><p>To verify that the AWS credentials are being injected into the container run the
following command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>PROVIDER_CONTROLLER_POD=$(kubectl -n crossplane-system get pod -l pkg.crossplane.io/provider=provider-aws -o name --no-headers=true)
</span></span><span style=display:flex><span>kubectl -n crossplane-system exec -it $PROVIDER_CONTROLLER_POD -c provider-aws -- cat /vault/secrets/creds.txt
</span></span></code></pre></div><h2 id=provision-infrastructure-1>Provision Infrastructure</h2><p>The final step is to actually provision a <code>Bucket</code>. Creating the
object below will result in the creation of a S3 bucket on AWS.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>echo &#34;apiVersion: s3.aws.crossplane.io/v1beta1
</span></span><span style=display:flex><span>kind: Bucket
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: s3-vault-demo
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  forProvider:
</span></span><span style=display:flex><span>    acl: private
</span></span><span style=display:flex><span>    locationConstraint: us-east-1
</span></span><span style=display:flex><span>    publicAccessBlockConfiguration:
</span></span><span style=display:flex><span>      blockPublicPolicy: true
</span></span><span style=display:flex><span>    tagging:
</span></span><span style=display:flex><span>      tagSet:
</span></span><span style=display:flex><span>        - key: Name
</span></span><span style=display:flex><span>          value: s3-vault-demo
</span></span><span style=display:flex><span>  providerConfigRef:
</span></span><span style=display:flex><span>    name: default&#34; | kubectl apply -f -
</span></span></code></pre></div><p>You can monitor the progress of the bucket provisioning with the following
command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>kubectl get bucket -w
</span></span></code></pre></div></div></div></div></div><script>var i,j,menu=[],menuDom,item,itemDom,children;menu.push({childCurrent:!1,children:[{current:!1,name:"Install \u0026 Configure",url:"/master/getting-started/install-configure/"},{current:!1,name:"Provision Infrastructure",url:"/master/getting-started/provision-infrastructure/"},{current:!1,name:"Create a Configuration",url:"/master/getting-started/create-configuration/"}],current:!1,name:"Getting Started",url:"/master/getting-started/"}),menu.push({childCurrent:!1,children:[{current:!1,name:"Providers",url:"/master/concepts/providers/"},{current:!1,name:"Managed Resources",url:"/master/concepts/managed-resources/"},{current:!1,name:"Composite Resources",url:"/master/concepts/composition/"},{current:!1,name:"Crossplane Packages",url:"/master/concepts/packages/"},{current:!1,name:"Terminology",url:"/master/concepts/terminology/"}],current:!1,name:"Concepts",url:"/master/concepts/"}),menu.push({childCurrent:!0,children:[{current:!1,name:"Upgrading to v0.14",url:"/master/guides/upgrading-to-v0.14/"},{current:!1,name:"Upgrading to v1.x",url:"/master/guides/upgrading-to-v1.x/"},{current:!1,name:"Vault as an External Secret Store",url:"/master/guides/vault-as-secret-store/"},{current:!0,name:"Vault Credential Injection",url:"/master/guides/vault-injection/"},{current:!1,name:"Multi-Tenant Crossplane",url:"/master/guides/multi-tenant/"},{current:!1,name:"Configuring Crossplane with Argo CD",url:"/master/guides/argo-cd-crossplane/"},{current:!1,name:"Self-Signed CA Certs",url:"/master/guides/self-signed-ca-certs/"},{current:!1,name:"Composition Revisions",url:"/master/guides/composition-revisions/"}],current:!1,name:"Guides",url:"/master/guides/"}),menu.push({childCurrent:!1,children:[{current:!1,name:"Install Crossplane",url:"/master/reference/install/"},{current:!1,name:"Configure Your Cloud Provider Account",url:"/master/reference/configure/"},{current:!1,name:"Uninstall Crossplane",url:"/master/reference/uninstall/"},{current:!1,name:"Composition",url:"/master/reference/composition/"},{current:!1,name:"xpkg Specification",url:"/master/reference/xpkg/"},{current:!1,name:"Troubleshoot",url:"/master/reference/troubleshoot/"},{current:!1,name:"Learn More",url:"/master/reference/learn_more/"},{current:!1,name:"Release Cycle",url:"/master/reference/release-cycle/"}],current:!1,name:"Reference",url:"/master/reference/"}),menu.push({childCurrent:!1,children:[{current:!1,name:"Crossplane",url:"/master/api-docs/crossplane/"},{current:!1,name:"provider-alibaba",url:"/master/api-docs/provider-alibaba/"},{current:!1,name:"provider-aws",url:"/master/api-docs/provider-aws/"},{current:!1,name:"provider-azure",url:"/master/api-docs/provider-azure/"},{current:!1,name:"provider-gcp",url:"/master/api-docs/provider-gcp/"},{current:!1,name:"provider-helm",url:"/master/api-docs/provider-helm/"},{current:!1,name:"provider-rook",url:"/master/api-docs/provider-rook/"}],current:!1,name:"API Documentation",url:"/master/api-docs/"}),menu.push({childCurrent:!1,children:[{current:!1,name:"Provider Development Guide",url:"/master/contributing/provider_development_guide/"},{current:!1,name:"Observability Developer Guide",url:"/master/contributing/observability_developer_guide/"},{current:!1,name:"Release Process",url:"/master/contributing/release-process/"},{current:!1,name:"Adding Secret Store Support",url:"/master/contributing/adding_external_secret_store_support/"},{current:!1,name:"Crossplane Documentation",url:"/master/contributing/docs/"}],current:!1,name:"Contributing",url:"/master/contributing/"}),menu.push({childCurrent:!1,children:[{current:!1,name:"Related Projects",url:"/master/faqs/related_projects/"}],current:!1,name:"FAQ",url:"/master/faqs/"});function getEntry(e){var t=document.createElement("li");return e.current?(t.innerHTML=e.name,t.classList.add("current")):t.innerHTML='<a href="'+e.url+'">'+e.name+"</a>",t}function flushCss(e){e.offsetHeight}function addArrow(e){var t=document.createElement("a");t.classList.add("arrow"),t.innerHTML="<div />",t.onclick=function(e){return function(){var n=59,s=16,t=n+s+e.lastChild.clientHeight+"px";return e.classList.toggle("open"),e.classList.contains("open")?e.style.height=t:(e.style.height==="auto"&&(e.style.transition="none",e.style.height=t,flushCss(e),e.style.transition=""),e.style.height="59px"),!1}}(e),e.appendChild(t),item.current&&item.children||item.childCurrent?(e.classList.add("open"),e.style.height="auto"):e.style.height="59px"}menuDom=document.getElementById("docs-ul");for(i=0;i<menu.length;i++){if(item=menu[i],itemDom=getEntry(item),item.childCurrent&&itemDom.classList.add("childCurrent"),item.children){addArrow(itemDom),itemDom.classList.add("children"),children=document.createElement("ul");for(j=0;j<item.children.length;j++)children.appendChild(getEntry(item.children[j]));itemDom.appendChild(children)}menuDom.appendChild(itemDom)}</script><script src=/js/anchor.js></script>
<script>anchors.options={placement:"right",icon:"#"},document.addEventListener("DOMContentLoaded",function(){anchors.add(".docs-content h1, .docs-content h2, .docs-content h3, .docs-content h4, .docs-content h5, .docs-content h6")})</script><div id=footer><div class=footer-main><div class=main><div class=logo><img src=/images/logo.svg alt="Crossplane Logo"></div></div><div class="links sm-hidden"><a href=https://twitter.com/crossplane_io>Twitter</a>
<a href=/v1.9/>Documentation</a>
<a href=https://github.com/crossplane/crossplane>GitHub</a>
<a href=https://slack.crossplane.io/>Slack Channel</a>
<a href=https://www.youtube.com/channel/UC19FgzMBMqBro361HbE46Fw>YouTube</a>
<a href=https://groups.google.com/forum/#!forum/crossplane-dev>Forum</a></div></div><div class=lf-copyright><p>&#169; Crossplane Authors 2022. Documentation distributed under
<a href=https://creativecommons.org/licenses/by/4.0/>CC-BY-4.0</a>.</p><p>&#169; 2022 The Linux Foundation. All rights reserved. The Linux Foundation has
registered trademarks and uses trademarks. For a list of trademarks of The Linux Foundation, please see our
<a href=https://www.linuxfoundation.org/trademark-usage/>Trademark Usage</a> page.</p></div><script src=/js/slack-popup.js></script></div><script>(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)})(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-110275540-2","auto"),ga("send","pageview")</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-SFCPQYSLHY"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-SFCPQYSLHY")</script><script type=text/javascript id=hs-script-loader async defer src=https://js.hs-scripts.com/5557732.js></script></body></html>